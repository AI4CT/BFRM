# BFRM系统流程图

## 整体工作流程

```mermaid
graph TD
    subgraph 输入阶段
        bubbly_flow.mp4 --> A1[加载气泡流视频]
        bubbly_flow.mp4 --> origin_frame
        A1 --> B1[视频预处理]
    end

    subgraph 后续优化
        A2[针对气泡流特征] --> B2[BubSort多目标追踪]
    end
    
    subgraph 检测与追踪阶段:bubble_csv
        B1 --> C[YOLOv11气泡检测（main.py）]
        C --> D[多目标追踪]
        B2 --> D[多目标追踪（BotSort）]
        D --> E[生成检测&追踪结果（bubble_csv）]
        D --> F[生成可视化追踪视频（detection_with_tracks.mp4）]
    end
    
    subgraph 分析阶段:analysis_results
        E --> G[读取检测CSV（bubble_analysis.py）]
        G --> I[气泡特性分析及可视化（visualizations）]
        G --> J[气泡区域提取（bubble_crops）]
    end
    
    subgraph 三维重建阶段:visualizations&bubble_info
        E --> L[三维流场初始化（第一帧，reconstruction3d.py）]
        L --> M[流场三维结构更新（bubble_info）]
        M --> N[生成三维可视化（visualizations）]
    end
    
    subgraph 在线分析与预测 未来计划
        N --> O[气泡流在线测量]
        O --> P[气泡流动态三维重建]
        O --> Q[气泡流超视野]
    end
    
    style C fill:#222222,stroke:#333
    style D fill:#222222,stroke:#333
    style E fill:#222222,stroke:#333
    style F fill:#222222,stroke:#333
    style G fill:#222222,stroke:#333
    style A2 fill:#084032,stroke:#333
    style B2 fill:#084032,stroke:#333
    style I fill:#222222,stroke:#333
    style J fill:#222222,stroke:#333
    style L fill:#222222,stroke:#333
    style M fill:#222222,stroke:#333,stroke-dasharray: 5 5
    style N fill:#222222,stroke:#333
    style O fill:#084032,stroke:#333,stroke-dasharray: 5 5
    style P fill:#084032,stroke:#333,stroke-dasharray: 5 5
    style Q fill:#084032,stroke:#333,stroke-dasharray: 5 5
```

## 文件存储结构

```mermaid
graph LR
    A[BFRM项目根目录] --> B[原始视频文件]
    A --> C[bubble_csv]
    A --> D[detection_with_tracks.mp4]
    A --> E[analysis_results]
    A --> F[bubble_info]
    A --> G[visualizations]
    
    C --> C1[frame_0001.csv]
    C --> C2[frame_0002.csv]
    C --> C3[...]
    
    E --> E1[visualizations]
    E --> E2[bubble_crops]
    E --> E3[bubble_count_animation.mp4]
    E --> E4[bubble_count_plot.png]
    E --> E5[bubble_statistics.csv]
    
    E1 --> E11[detection_results]
    E1 --> E12[trajectories]
    
    E11 --> E111[detection_results.mp4]
    E11 --> E112[frame_0001.png]
    E11 --> E113[frame_0002.png]
    E11 --> E114[...]
    
    E12 --> E121[bubble_trajectories.mp4]
    E12 --> E122[frame_0001.png]
    E12 --> E123[frame_0002.png]
    E12 --> E124[...]
    
    E2 --> E21[bubble_id（按气泡ID组织）]
    E2 --> E22[frame_id（按帧号组织）]
    E2 --> E23[single（按气泡类别组织）]
    E2 --> E24[overlap（按气泡类别组织）]

    E21 --> E211[bubble_0001]
    E21 --> E212[...]

    E211 --> E2111[bubble_info.csv]
    E211 --> E2112[frame_0001.png]
    E211 --> E2113[...]
    
    E22 --> E221[bubble_0001]
    E22 --> E222[...]

    E221 --> E2211[bubble_info.csv]
    E221 --> E2212[frame_0001.png]
    E221 --> E2213[...]

    E23 --> E231[frame_0001_bubble_0001.png]
    E23 --> E232[frame_0001_bubble_0002.png]
    E23 --> E233[...]
    
    E24 --> E241[frame_0001_bubble_0028.png]
    E24 --> E242[frame_0001_bubble_0031.png]
    E24 --> E243[...]

    E3 --> E31[气泡数量实时监控]
    E4 --> E41[气泡信息数量统计]
    E5 --> E51[气泡信息数量统计]

    F --> F1[frame_0001_3d.csv]
    F --> F2[frame_0002_3d.csv]
    F --> F3[...]
    F --> F4[frame_XXXX_bubble_info.json]
    
    G --> G1[3d_bubbles.stl]
    G --> G2[3d_visualization.png]
    G --> G3[3d_front_view.png]
    G --> G4[3d_side_view.png]
    G --> G5[3d_top_view.png]
    G1 --> G2
    G1 --> G3
    G1 --> G4
    G1 --> G5

    G --> G6[density_estimation.png]
    G --> G7[气泡流场可视化.html]



    
    style C fill:#222222,stroke:#333
    style D fill:#222222,stroke:#333
    style E fill:#222222,stroke:#333
    style F fill:#cfc,stroke:#333
    style G fill:#cfc,stroke:#333
```

## 算法与模块关系

```mermaid
graph LR
    subgraph GUI模块
        A1[主窗口] --> A2[视频播放]
        A1 --> A3[参数设置]
        A1 --> A4[结果显示]
    end
    
    subgraph 检测与追踪模块
        B1[YOLOv8] --> B2[BotSort]
        B2 --> B3[BubSort未来计划]
    end
    
    subgraph 分析模块
        C1[数据处理] --> C2[统计分析]
        C1 --> C3[可视化]
    end
    
    subgraph 三维重建模块
        D1[椭球体模型] --> D2[空间初始化]
        D2 --> D3[结构更新未完成]
        D3 --> D4[三维可视化]
    end
    
    A1 --> B1
    B2 --> C1
    C1 --> D1
    
    style B3 fill:#fcf,stroke:#333,stroke-dasharray: 5 5
    style D3 fill:#fcf,stroke:#333,stroke-dasharray: 5 5
```

## 图例说明

- <span style="color:#222222">■</span> 已完成功能
- <span style="color:#cfc">■</span> 部分完成功能
- <span style="color:#fcf">■</span> 未完成功能（计划中）
- <span style="color:#333; text-decoration:dashed">- - -</span> 开发中功能

## 数据流向

```mermaid
flowchart TD
    subgraph 输入数据
        A[原始视频文件]
    end
    
    subgraph 中间数据
        B[检测结果CSV]
        C[追踪轨迹数据]
    end
    
    subgraph 分析结果
        D[气泡统计报告]
        E[气泡区域图像]
    end
    
    subgraph 三维数据
        F[三维坐标信息]
        G[椭球体参数]
    end
    
    subgraph 输出结果
        H[可视化视频]
        I[三维交互模型]
        J[分析图表]
    end
    
    A --> main.py
    main.py --> gui.py
    gui.py --> B
    gui.py --> C
    B --> bubble_analysis.py
    C --> bubble_analysis.py
    bubble_analysis.py --> D
    bubble_analysis.py --> E
    B --> reconstruction3d.py
    C --> reconstruction3d.py
    reconstruction3d.py --> F
    reconstruction3d.py --> G
    F --> I
    G --> I
    D --> J
    E --> H
``` 
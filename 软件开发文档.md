# 气泡流场三维重建系统开发文档

## 目录
1. [系统概述](#1-系统概述)
2. [需求分析](#2-需求分析)
3. [系统设计](#3-系统设计)
4. [模块设计](#4-模块设计)
5. [接口设计](#5-接口设计)
6. [测试方案](#6-测试方案)
7. [部署与维护](#7-部署与维护)
8. [更新日志](#8-更新日志)
9. [附录](#9-附录)

## 1. 系统概述
本系统针对高速气泡流场研究需求，实现从多视角图像序列到三维流场结构的完整重建流程。系统包含7个核心模块，支持从原始数据采集到三维可视化交互的全链条处理。

## 2. 需求分析
### 2.1 功能性需求
- 数据采集：支持10,000+ fps高速相机数据流捕获
- 图像预处理：实现噪声消除、对比度增强、ROI提取
- 气泡检测：亚像素级精度识别，检测率>98%
- 三维重建：多视角匹配误差<0.1px
- 可视化：支持10^6+气泡实时渲染

### 2.2 非功能性需求
| 指标类型 | 要求标准 |
|---------|---------|
| 处理速度 | 单帧处理时间<50ms @4K分辨率 |
| 内存管理 | 支持64GB+大容量数据缓存 |
| 精度要求 | Z轴重建误差<直径的5% |
| 兼容性  | 支持Basler/Phantom主流相机SDK |

## 3. 系统设计
### 3.1 架构设计
系统采用分层架构设计，主要包含以下层次：

1. 数据采集层
   - 相机控制与数据获取
   - 原始数据缓存管理
   - 数据格式转换

2. 图像处理层
   - 预处理模块
   - 目标检测模块
   - 特征提取模块

3. 三维重建层
   - 多视角匹配
   - 三维坐标计算
   - 轨迹重建

4. 应用层
   - 可视化界面
   - 用户交互
   - 数据导出

### 3.2 核心技术栈
- 开发语言：Python 3.8+
- 图像处理：OpenCV 4.8
- 深度学习：PyTorch 2.0, YOLO v8
- 三维重建：Open3D 0.17
- 可视化：VTK 9.2
- GUI框架：PyQt6

## 4. 模块设计
### 4.1 数据采集模块
#### 4.1.1 功能描述
- 支持多种型号高速相机接入
- 实时数据流采集与缓存
- 多相机同步触发控制

#### 4.1.2 核心类设计
```python
class DataAcquisition:
    def __init__(self, camera_params):
        """
        参数初始化
        camera_params: 相机参数配置字典
        """
        self.buffer_size = camera_params['buffer']
        self.fps = camera_params['max_fps']
        self.resolution = camera_params['resolution']
        
    def start_capture(self):
        """启动数据采集"""
        pass
        
    def stop_capture(self):
        """停止数据采集"""
        pass
```

### 4.2 图像预处理模块
#### 4.2.1 功能描述
- 图像去噪与增强
- 背景消除
- ROI提取
- 图像校正

#### 4.2.2 关键算法
```python
class ImagePreprocessor:
    def denoise(self, image):
        """
        非局部均值去噪
        """
        return cv2.fastNlMeansDenoising(image)
    
    def enhance_contrast(self, image):
        """
        自适应直方图均衡化
        """
        clahe = cv2.createCLAHE(clipLimit=2.0, tileGridSize=(8,8))
        return clahe.apply(image)
```

### 4.3 气泡检测模块
#### 4.3.1 功能描述
- 气泡轮廓提取
- 椭圆拟合
- 特征参数计算
- YOLO深度学习检测

#### 4.3.2 实现方法
```python
class BubbleDetector:
    def detect(self, image):
        """
        气泡检测主函数
        """
        # 边缘检测
        edges = cv2.Canny(image, 50, 150)
        
        # 轮廓提取
        contours, _ = cv2.findContours(edges, cv2.RETR_EXTERNAL, 
                                     cv2.CHAIN_APPROX_NONE)
        
        # 椭圆拟合
        bubbles = []
        for contour in contours:
            if len(contour) >= 5:
                ellipse = cv2.fitEllipse(contour)
                bubbles.append(ellipse)
                
        return bubbles
```

### 4.4 三维重建模块
#### 4.4.1 功能描述
- 相机标定
- 特征点匹配
- 三维坐标计算
- 轨迹重建

#### 4.4.2 核心算法
```python
class Reconstructor3D:
    def __init__(self, camera_matrices):
        """
        初始化重建器
        camera_matrices: 相机内外参数
        """
        self.camera_matrices = camera_matrices
        
    def triangulate(self, points_2d):
        """
        三角测量计算三维坐标
        """
        points_3d = cv2.triangulatePoints(self.camera_matrices[0],
                                        self.camera_matrices[1],
                                        points_2d[0].T,
                                        points_2d[1].T)
        return points_3d
```

### 4.5 GUI界面模块
#### 4.5.1 功能描述
- 视频播放控制
- 气泡信息实时显示
- 轨迹可视化
- 参数调整界面

#### 4.5.2 核心类设计
```python
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.init_ui()
        self.init_yolo_model()
        
    def init_ui(self):
        """初始化用户界面"""
        # 创建主显示区域
        self.create_main_display_area()
        # 创建信息面板
        self.create_info_panel()
        # 添加视频控制
        self.add_video_controls()
        
    def update_display(self, frame_index):
        """更新显示内容"""
        # 处理当前帧
        processed_frame, frame_info = self.process_frame_with_yolo(
            self.frames[frame_index], frame_index)
        # 更新气泡信息显示
        self.update_bubble_info_display(frame_info)
```

## 5. 接口设计
### 5.1 模块间接口
```python
class Pipeline:
    def __init__(self):
        self.preprocessor = ImagePreprocessor()
        self.detector = BubbleDetector()
        self.reconstructor = Reconstructor3D()
    
    def process_frame(self, frame):
        """
        单帧处理流程
        """
        # 预处理
        processed = self.preprocessor.process(frame)
        
        # 气泡检测
        bubbles = self.detector.detect(processed)
        
        # 三维重建
        coords_3d = self.reconstructor.reconstruct(bubbles)
        
        return coords_3d
```

### 5.2 数据接口
#### 5.2.1 气泡特征数据结构
```python
bubble_data = {
    'id': int,  # 气泡ID
    'frame_id': int,  # 帧序号
    'timestamp': float,  # 时间戳
    'position': {  # 三维坐标
        'x': float,
        'y': float,
        'z': float
    },
    'size': {  # 气泡尺寸
        'width': float,
        'height': float,
        'angle': float
    },
    'velocity': float,  # 速度
    'volume': float  # 体积
}
```

## 6. 测试方案
### 6.1 单元测试
- 模块功能测试
- 边界条件测试
- 异常处理测试

### 6.2 集成测试
- 模块间接口测试
- 数据流通测试
- 性能压力测试

### 6.3 系统测试
- 功能完整性测试
- 稳定性测试
- 精度验证测试

## 7. 部署与维护
### 7.1 环境配置
```
# requirements.txt
numpy>=1.24.3
opencv-contrib-python>=4.8.0.76
torch>=2.0.1
open3d>=0.17.0
vtk>=9.2.0
pyqt6>=6.5.0
ultralytics>=8.0.0
```

### 7.2 部署步骤
1. 环境准备
   ```bash
   pip install -r requirements.txt
   ```

2. 模型下载
   ```bash
   # 下载YOLO预训练模型
   python -c "from ultralytics import YOLO; YOLO('yolov8n.pt')"
   ```

3. 启动应用
   ```bash
   python main.py
   ```

## 8. 更新日志

### 2025年3月5日更新
1. 界面优化
   - 移除了视频信息窗口，使界面更加简洁
   - 为气泡信息区域添加滚动条功能，支持大量气泡信息显示
   - 优化了气泡信息表格样式，添加行号列
   - 修复了字体警告问题

2. 功能改进
   - 视频循环播放时自动清空气泡轨迹，避免轨迹混乱
   - 气泡数量显示改为实时参数
   - 优化了表格头部固定功能，方便查看列名

3. 性能优化
   - 减少不必要的UI更新，提高播放流畅度
   - 优化日志记录方式，减少控制台输出

### 2025年2月25日更新
1. 集成YOLO检测模型
   - 添加实时气泡检测功能
   - 支持气泡参数自动计算

2. 界面改进
   - 添加视频控制工具栏
   - 支持播放速度调整
   - 添加循环播放功能

## 9. 附录
### 9.1 参考文献
1. Lindken, R., & Merzkirch, W. (2002). A novel PIV technique for measurements in multiphase flows and its application to two-phase bubbly flows. Experiments in fluids, 33(6), 814-825.
2. Jocher, G., Chaurasia, A., & Qiu, J. (2023). YOLO by Ultralytics (Version 8.0.0) [Computer software]. https://github.com/ultralytics/ultralytics
3. Bradski, G. (2000). The OpenCV Library. Dr. Dobb's Journal of Software Tools.
